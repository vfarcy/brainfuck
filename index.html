<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† BrainJS: Interpr√©teur Brainfuck</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }
        h1, h2 {
            color: #333;
        }
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }
        .editor-wrapper {
            position: relative;
            width: 100%;
            margin-top: 8px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            overflow: hidden;
        }
        .editor-wrapper textarea,
        .editor-wrapper pre {
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            tab-size: 2;
        }
        .editor-wrapper pre {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: hidden;
            pointer-events: none;
            background-color: #fff;
        }
        .editor-wrapper textarea {
            position: relative;
            z-index: 1;
            width: 100%;
            height: 100%;
            padding: 10px;
            border: none;
            background-color: transparent;
            color: transparent;
            caret-color: #222;
            resize: vertical;
            -webkit-text-fill-color: transparent;
        }
        .editor-wrapper textarea:focus {
            outline: none;
        }
        .code-editor::selection {
            background-color: rgba(33, 150, 243, 0.35);
        }
        .bf-token {
            display: inline;
            color: #444;
        }
        .bf-comment {
            color: #bdbdbd;
        }
        .bf-move-right,
        .bf-move-left {
            color: #1565c0;
        }
        .bf-increment,
        .bf-decrement {
            color: #2e7d32;
        }
        .bf-output {
            color: #ef6c00;
        }
        .bf-input {
            color: #8e24aa;
        }
        .bf-loop-start,
        .bf-loop-end {
            color: #d81b60;
        }
        .bf-active {
            background-color: #ff9900;
            color: #fff !important;
            border-radius: 3px;
            padding: 0 2px;
        }
        button {
            padding: 10px 15px;
            margin-right: 10px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #run-all { background-color: #4CAF50; color: white; }
        #run-all:hover:not(:disabled) { background-color: #45a049; }
        #step-btn { background-color: #2196F3; color: white; }
        #step-btn:hover:not(:disabled) { background-color: #0b7dda; }
        #reset-btn { background-color: #f44336; color: white; }
        #reset-btn:hover:not(:disabled) { background-color: #da190b; }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* --- Styles de Sortie et M√©moire --- */
        #output-view, #code-view {
            white-space: pre-wrap;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
            min-height: 50px;
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
            overflow: auto;
        }
        #memory-view {
            max-width: 100%;
        }
        .memory-scroll-wrapper {
            width: 100%;
            max-width: 100%;
        }
        .memory-scroll {
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fff;
        }
        .memory-scroll::-webkit-scrollbar {
            height: 8px;
        }
        .memory-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.25);
            border-radius: 4px;
        }
        .memory-scroll::-webkit-scrollbar-track {
            background-color: rgba(0,0,0,0.05);
        }
        .memory-scroll table {
            border-collapse: collapse;
            font-size: 14px;
            min-width: 500px;
            width: max-content;
        }
        .memory-scroll td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            white-space: nowrap;
        }
        .memory-scroll-slider {
            width: 100%;
            margin-top: 6px;
            appearance: none;
            height: 6px;
            border-radius: 4px;
            background: #d0d0d0;
            cursor: pointer;
        }
        .memory-scroll-slider:focus {
            outline: 2px solid rgba(33, 150, 243, 0.4);
            outline-offset: 2px;
        }
        .memory-scroll-slider::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #2196F3;
            border: none;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        .memory-scroll-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #2196F3;
            border: none;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        .header-row td {
            font-weight: bold;
            background-color: #f0f0f0;
            color: #555;
        }
        .active-cell {
            background-color: #ff9900 !important;
            color: white;
            font-weight: bold;
            border-color: #cc7a00 !important;
        }
        .ellipsis-cell {
            font-weight: bold;
            color: #999;
        }
    </style>
</head>
<body>

    <h1>üß† BrainJS: Interpr√©teur Brainfuck</h1>

    <label for="bf-code">Entrez votre programme Brainfuck :</label>
    <div class="editor-wrapper">
        <pre id="code-highlight" aria-hidden="true"></pre>
        <textarea id="bf-code" class="code-editor" rows="10" cols="80">++++++++[>++++[>++>+++>+++>+<<<<-]>+>+>->>+[<]<-]>>.>---.+++++++..+++.>>.<-.<.+++.------.--------.>>+.>++.</textarea>
    </div>
    
    <p>
        <button id="run-all" aria-label="Ex√©cuter d'un coup">‚ñ∂ Ex√©cuter D'un Coup</button>
        <button id="step-btn" aria-label="Ex√©cuter pas √† pas">üë£ Ex√©cuter Pas √† Pas</button>
        <button id="reset-btn" aria-label="R√©initialiser">üîÑ R√©initialiser</button>
    </p>

    <hr>
    
    <h2>Donn√©es d'Entr√©e (Input)</h2>
    <textarea id="bf-input" rows="3" cols="80" placeholder="Entrez les donn√©es lues par la commande ',' (virgule) ici. Par exemple: 'Hello'"></textarea>

    <h2>Sortie (Output)</h2>
    <pre id="output-view">En attente d'ex√©cution...</pre>

    <hr>

    <h2>√âtat de l'Interpr√©teur</h2>
    <p>
        Pointeur d'Instruction (IP): <span id="ip-view">0</span>
        &nbsp;|&nbsp;
        Pointeur de Cellule (PTR): <span id="ptr-view">0</span>
    </p>

    <h3>Code en cours d'ex√©cution</h3>
    <pre id="code-view"></pre>

    <h3>M√©moire (Cellules autour du PTR)</h3>
    <div id="memory-view"></div>

    <script src="BrainfuckInterpreter.js"></script> 

    <script>
        let interpreter = null;

        // R√©f√©rences DOM
        const codeInput = document.getElementById('bf-code');
        const inputData = document.getElementById('bf-input');
        const outputView = document.getElementById('output-view');
        const ipView = document.getElementById('ip-view');
        const ptrView = document.getElementById('ptr-view');
        const memoryView = document.getElementById('memory-view');
        const codeView = document.getElementById('code-view');
        const codeHighlight = document.getElementById('code-highlight');
        const runAllBtn = document.getElementById('run-all');
        const stepBtn = document.getElementById('step-btn');
        const resetBtn = document.getElementById('reset-btn');

        const BF_TOKEN_CLASSES = {
            '>': 'bf-move-right',
            '<': 'bf-move-left',
            '+': 'bf-increment',
            '-': 'bf-decrement',
            '.': 'bf-output',
            ',': 'bf-input',
            '[': 'bf-loop-start',
            ']': 'bf-loop-end'
        };

        function escapeHtml(text) {
            return text.replace(/[&<>"']/g, (char) => {
                switch (char) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return char;
                }
            });
        }

        function buildHighlightedHtml(source, activeIndex = null) {
            if (!source) return '';
            let html = '';
            for (let i = 0; i < source.length; i++) {
                const char = source[i];
                if (char === '\n') {
                    html += '\n';
                    continue;
                }
                const classes = ['bf-token'];
                const tokenClass = BF_TOKEN_CLASSES[char] || 'bf-comment';
                classes.push(tokenClass);
                if (activeIndex !== null && i === activeIndex) {
                    classes.push('bf-active');
                }
                html += `<span class="${classes.join(' ')}">${escapeHtml(char)}</span>`;
            }
            return html;
        }

        function renderEditorHighlight(activeOriginalIndex = null) {
            codeHighlight.innerHTML = buildHighlightedHtml(codeInput.value, activeOriginalIndex);
            syncHighlightScroll();
        }

        function syncHighlightScroll() {
            codeHighlight.style.transform = `translate(${-codeInput.scrollLeft}px, ${-codeInput.scrollTop}px)`;
            // La transformation est plus fluide si elle est dans une frame d'animation
            requestAnimationFrame(() => {
                codeHighlight.style.transform = `translate(${-codeInput.scrollLeft}px, ${-codeInput.scrollTop}px)`;
            });
        }

        function setupMemoryScrollbar(wrapper) {
            if (!wrapper) return;

            const scrollContainer = wrapper.querySelector('.memory-scroll');
            const slider = wrapper.querySelector('.memory-scroll-slider');

            if (!scrollContainer || !slider) return;

            const updateSlider = () => {
                const overflow = scrollContainer.scrollWidth - scrollContainer.clientWidth;
                if (overflow > 0.5) {
                    slider.style.display = 'block';
                    slider.max = overflow;
                    slider.value = Math.min(scrollContainer.scrollLeft, overflow);
                } else {
                    slider.style.display = 'none';
                    slider.value = 0;
                    scrollContainer.scrollLeft = 0;
                }
            };

            slider.addEventListener('input', () => {
                scrollContainer.scrollLeft = Number(slider.value);
            });

            scrollContainer.addEventListener('scroll', () => {
                slider.value = scrollContainer.scrollLeft;
            });

            requestAnimationFrame(updateSlider);
        }

        codeInput.addEventListener('input', () => {
            renderEditorHighlight();
        });

        codeInput.addEventListener('scroll', () => {
            syncHighlightScroll();
        });
        
        window.addEventListener('resize', () => {
            syncHighlightScroll();
            if (interpreter) {
                updateUI();
            }
        });

        // Premi√®re coloration au chargement du script
        renderEditorHighlight();
        
        /**
         * Initialise ou r√©initialise l'interpr√©teur avec le code et les donn√©es d'entr√©e.
         */
        function initializeInterpreter() {
            try {
                // Passage du code et des donn√©es d'entr√©e
                interpreter = new BrainfuckInterpreter(codeInput.value, inputData.value); 
                updateUI();
                runAllBtn.disabled = false;
                stepBtn.disabled = false;
                outputView.textContent = "Programme r√©initialis√©.";
            } catch (error) {
                alert("Erreur de syntaxe Brainfuck: " + error.message);
                interpreter = null;
            }
        }

        /**
         * Met √† jour tous les √©l√©ments de l'interface utilisateur.
         */
        function updateUI() {
            if (!interpreter) return;

            const state = interpreter.getState();

            // 1. Mise √† jour des compteurs et sortie
            outputView.textContent = state.output;
            ipView.textContent = state.ip;
            ptrView.textContent = state.ptr;

            // 2. Visualisation du code et du Pointeur d'Instruction (IP)
            
            const activeInstructionIndex = state.code.length === 0
                ? null
                : (state.ip < state.code.length ? state.ip : state.code.length - 1);
            const activeOriginalIndex = (!state.codeMap || state.codeMap.length === 0)
                ? null
                : (state.ip < state.codeMap.length ? state.codeMap[state.ip] : state.codeMap[state.codeMap.length - 1]);

            codeView.innerHTML = buildHighlightedHtml(state.code, activeInstructionIndex);
            renderEditorHighlight(activeOriginalIndex);


            // 3. Visualisation de la m√©moire et du Pointeur de Cellule (PTR)
            let memDisplay = '<table>';
            const windowRadius = 7;
            const memoryLength = state.memoryFull.length;
            const start = Math.max(0, state.ptr - windowRadius);
            const end = Math.min(state.ptr + windowRadius + 1, memoryLength);

            // Ligne 1: Index (PTR)
            memDisplay += '<tr class="header-row">';
            if (start > 0) {
                memDisplay += '<td class="ellipsis-cell">‚Ä¶</td>';
            }
            for (let i = start; i < end; i++) {
                memDisplay += `<td>${i}</td>`;
            }
            if (end < memoryLength) {
                memDisplay += '<td class="ellipsis-cell">‚Ä¶</td>';
            }
            memDisplay += '</tr>';

            // Ligne 2: Valeurs (Contenu de la cellule)
            memDisplay += '<tr>';
            if (start > 0) {
                memDisplay += '<td class="ellipsis-cell">‚Ä¶</td>';
            }
            for (let i = start; i < end; i++) {
                const cellClass = i === state.ptr ? 'active-cell' : '';
                memDisplay += `<td class="${cellClass}">${state.memoryFull[i]}</td>`;
            }
            if (end < memoryLength) {
                memDisplay += '<td class="ellipsis-cell">‚Ä¶</td>';
            }
            memDisplay += '</tr>';
            memDisplay += '</table>';

            memoryView.innerHTML = `
                <div class="memory-scroll-wrapper">
                    <div class="memory-scroll" role="region" aria-label="Fen√™tre m√©moire d√©filable">${memDisplay}</div>
                    <input type="range" class="memory-scroll-slider" min="0" value="0" step="1" aria-label="D√©filement horizontal de la m√©moire">
                </div>
            `;

            const memoryWrapper = memoryView.querySelector('.memory-scroll-wrapper');
            setupMemoryScrollbar(memoryWrapper);

            // 4. Gestion de la fin du programme
            if (state.halted) {
                runAllBtn.disabled = true;
                stepBtn.disabled = true;
                if (!outputView.textContent.includes("termin√©")) {
                    outputView.textContent += "\n\n--- Programme termin√© ---";
                }
            }
        }

        // --- Gestionnaires d'√©v√©nements ---

        runAllBtn.addEventListener('click', () => {
            // R√©initialiser s'il n'y a pas d'interpr√©teur ou si l'ex√©cution pr√©c√©dente est termin√©e
            if (!interpreter || interpreter.getState().halted) initializeInterpreter();
            if (interpreter) {
                interpreter.runAll();
                updateUI();
            }
        });

        stepBtn.addEventListener('click', () => {
            if (!interpreter || interpreter.getState().halted) initializeInterpreter(); 
            if (interpreter) {
                interpreter.step();
                updateUI();
            }
        });

        resetBtn.addEventListener('click', () => {
            initializeInterpreter();
        });

        // Initialisation apr√®s le chargement complet
        window.addEventListener('load', () => {
            if (typeof BrainfuckInterpreter === 'undefined') {
                alert("Erreur: Le fichier 'BrainfuckInterpreter.js' n'a pas √©t√© trouv√© ou charg√© correctement. V√©rifiez le chemin.");
            } else {
                initializeInterpreter();
            }
        });

    </script>
</body>
</html>
